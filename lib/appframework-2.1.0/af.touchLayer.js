(function($){"use strict";$.touchLayer=function(el){$.touchLayer=new touchLayer(el);return $.touchLayer};var inputElements=["input","select","textarea"];var autoBlurInputTypes=["button","radio","checkbox","range","date"];var requiresJSFocus=$.os.ios;var verySensitiveTouch=$.os.blackberry;var inputElementRequiresNativeTap=$.os.blackberry||$.os.fennec||($.os.android&&!$.os.chrome);var requirePanning=$.os.ios&&!$.os.ios7;var addressBarError=0.97;var maxHideTries=2;var skipTouchEnd=false;var cancelClick=false;function getTime(){var d=new Date();var n=d.getTime();return n}var touchLayer=function(el){this.clearTouchVars();el.addEventListener("touchstart",this,false);el.addEventListener("touchmove",this,false);el.addEventListener("touchend",this,false);el.addEventListener("click",this,false);el.addEventListener("focusin",this,false);document.addEventListener("scroll",this,false);window.addEventListener("resize",this,false);window.addEventListener("orientationchange",this,false);this.layer=el;this.scrollEndedProxy_=$.proxy(this.scrollEnded,this);this.exitEditProxy_=$.proxy(this.exitExit,this,[]);this.launchFixUIProxy_=$.proxy(this.launchFixUI,this);var that=this;this.scrollTimeoutExpireProxy_=function(){that.scrollTimeout_=null;that.scrollTimeoutEl_.addEventListener("scroll",that.scrollEndedProxy_,false)};this.retestAndFixUIProxy_=function(){if($.os.android&&!$.os.chrome)that.layer.style.height="100%";$.asap(that.testAndFixUI,that,arguments)};document.addEventListener("click",function(e){if(cancelClick){e.preventDefault();e.stopPropagation();return false}if(e.clientX!==undefined&&that.lastTouchStartX!==null){if(2>Math.abs(that.lastTouchStartX-e.clientX)&&2>Math.abs(that.lastTouchStartY-e.clientY)){e.preventDefault();e.stopPropagation()}}},true);$.bind(this,"scrollstart",function(el){that.isScrolling=true;that.scrollingEl_=el;if(!$.feat.nativeTouchScroll)that.scrollerIsScrolling=true;that.fireEvent("UIEvents","scrollstart",el,false,false)});$.bind(this,"scrollend",function(el){that.isScrolling=false;if(!$.feat.nativeTouchScroll)that.scrollerIsScrolling=false;that.fireEvent("UIEvents","scrollend",el,false,false)});this.hideAddressBar(0,1);this.launchFixUI(5)};touchLayer.prototype={dX:0,dY:0,cX:0,cY:0,touchStartX:null,touchStartY:null,layer:null,scrollingEl_:null,scrollTimeoutEl_:null,scrollTimeout_:null,reshapeTimeout_:null,scrollEndedProxy_:null,exitEditProxy_:null,launchFixUIProxy_:null,reHideAddressBarTimeout_:null,retestAndFixUIProxy_:null,panElementId:"header",blockClicks:false,allowDocumentScroll_:false,ignoreNextResize_:false,blockPossibleClick_:false,isScrolling:false,isScrollingVertical_:false,wasPanning_:false,isPanning_:false,isFocused_:false,justBlurred_:false,requiresNativeTap:false,holdingReshapeType_:null,trackingClick:false,scrollerIsScrolling:false,handleEvent:function(e){switch(e.type){case"touchstart":this.onTouchStart(e);break;case"touchmove":this.onTouchMove(e);break;case"touchend":this.onTouchEnd(e);break;case"click":this.onClick(e);break;case"blur":this.onBlur(e);break;case"scroll":this.onScroll(e);break;case"orientationchange":this.onOrientationChange(e);break;case"resize":this.onResize(e);break;case"focusin":this.onFocusIn(e);break}},launchFixUI:function(maxTries){if(!maxTries)maxTries=maxHideTries;if(this.reHideAddressBarTimeout_===null)return this.testAndFixUI(0,maxTries)},resetFixUI:function(){if(this.reHideAddressBarTimeout_)clearTimeout(this.reHideAddressBarTimeout_);this.reHideAddressBarTimeout_=null},testAndFixUI:function(retry,maxTries){var refH=this.getReferenceHeight();var curH=this.getCurrentHeight();if((refH!==curH&&!(curH*addressBarError<refH&&refH*addressBarError<curH))){this.hideAddressBar(retry,maxTries);return true}if($.os.android)this.resetFixUI();return false},hideAddressBar:function(retry,maxTries){if($.ui&&$.ui.isIntel)return;if(retry>=maxTries){this.resetFixUI();return}if($.os.desktop||$.os.kindle){this.layer.style.height="100%"}else if($.os.android){window.scrollTo(1,1);this.layer.style.height=this.isFocused_||window.innerHeight>=window.outerHeight?(window.innerHeight)+"px":(window.outerHeight)+"px";var that=this;var nextTry=retry+1;this.reHideAddressBarTimeout_=setTimeout(that.retestAndFixUIProxy_,250*nextTry,nextTry,maxTries)}else if(!this.isFocused_){document.documentElement.style.height="5000px";window.scrollTo(0,0);document.documentElement.style.height=window.innerHeight+"px";this.layer.style.height=window.innerHeight+"px"}},getReferenceHeight:function(){return window.innerHeight},getCurrentHeight:function(){if($.os.android){return window.innerHeight}else return numOnly(document.documentElement.style.height)},onOrientationChange:function(e){var self=this;var didBlur=false;if(this.focusedElement){didBlur=true;this.focusedElement.blur()}if(!this.holdingReshapeType_&&this.reshapeTimeout_){this.fireReshapeEvent("orientationchange")}else this.previewReshapeEvent("orientationchange");if($.os.android&&$.os.chrome){this.layer.style.height="100%";var time=didBlur?600:0;setTimeout(function(){self.hideAddressBar(0,1)},time)}},onResize:function(e){if(this.ignoreNextResize_){this.ignoreNextResize_=false;return}if(this.launchFixUI()){this.reshapeAction()}},onClick:function(e){var tag=e.target&&e.target.tagName!==undefined?e.target.tagName.toLowerCase():"";if(inputElements.indexOf(tag)!==-1&&(!this.isFocused_||e.target!==(this.focusedElement))){var type=e.target&&e.target.type!==undefined?e.target.type.toLowerCase():"";var autoBlur=autoBlurInputTypes.indexOf(type)!==-1;if(!autoBlur){if(this.isFocused_){this.focusedElement.removeEventListener("blur",this,false)}this.focusedElement=e.target;this.focusedElement.addEventListener("blur",this,false);if(!this.isFocused_&&!this.justBlurred_){$.trigger(this,"enter-edit",[e.target]);if($.os.ios){var that=this;setTimeout(function(){that.fireReshapeEvent("enter-edit")},300)}else this.previewReshapeEvent("enter-edit")}this.isFocused_=true}else{this.isFocused_=false}this.justBlurred_=false;this.allowDocumentScroll_=true;if(requiresJSFocus){e.target.focus()}}else if($.os.blackberry10&&this.isFocused_){this.focusedElement.blur()}},previewReshapeEvent:function(ev){var that=this;this.reshapeTimeout_=setTimeout(function(){that.fireReshapeEvent(ev);that.reshapeTimeout_=null;that.holdingReshapeType_=null},750);this.holdingReshapeType_=ev},fireReshapeEvent:function(ev){$.trigger(this,"reshape");$.trigger(this,ev?ev+"-reshape":"unknown-reshape")},reshapeAction:function(){if(this.reshapeTimeout_){clearTimeout(this.reshapeTimeout_);this.fireReshapeEvent(this.holdingReshapeType_);this.holdingReshapeType_=null;this.reshapeTimeout_=null}else this.previewReshapeEvent()},onFocusIn:function(e){if(!this.isFocused_)this.onClick(e)},onBlur:function(e){if($.os.android&&e.target===window)return;this.isFocused_=false;if(this.focusedElement)this.focusedElement.removeEventListener("blur",this,false);this.focusedElement=null;this.justBlurred_=true;$.asap(this.exitEditProxy_,this,[e.target])},exitExit:function(el){this.justBlurred_=false;if(!this.isFocused_){$.trigger(this,"exit-edit",[el]);this.allowDocumentScroll_=false;if($.os.ios){var that=this;setTimeout(function(){that.fireReshapeEvent("exit-edit")},300)}else this.previewReshapeEvent("exit-edit")}},onScroll:function(e){if(!this.allowDocumentScroll_&&!this.isPanning_&&e.target===document){this.allowDocumentScroll_=true;if(this.wasPanning_){this.wasPanning_=false;setTimeout(this.launchFixUIProxy_,2000,[maxHideTries])}else{this.launchFixUI()}}},onTouchStart:function(e){this.dX=e.touches[0].pageX;this.dY=e.touches[0].pageY;this.lastTimestamp=e.timeStamp;this.lastTouchStartX=this.lastTouchStartY=null;if($.os.ios){if(skipTouchEnd===e.touches[0].identifier){cancelClick=true;e.preventDefault();skipTouchEnd=false;return false}skipTouchEnd=e.touches[0].identifier;cancelClick=false}if(this.scrollerIsScrolling){this.moved=true;this.scrollerIsScrolling=false;e.preventDefault();return false}this.trackingClick=true;if(requirePanning||$.feat.nativeTouchScroll)this.checkDOMTree(e.target,this.layer);if(this.isScrolling){if(this.scrollTimeout_!==null){clearTimeout(this.scrollTimeout_);this.scrollTimeout_=null;if(this.scrollTimeoutEl_!==this.scrollingEl_)this.scrollEnded(false);else this.blockPossibleClick_=true}else if(this.scrollTimeoutEl_){this.scrollEnded(true);this.blockPossibleClick_=true}}var forceNativeTap=($.os.android&&e&&e.target&&e.target.getAttribute&&e.target.getAttribute("data-touchlayer")==="ignore");if(forceNativeTap||(this.isFocused_&&!$.os.blackberry10)){this.requiresNativeTap=true;this.allowDocumentScroll_=true}else if(inputElementRequiresNativeTap&&e.target&&e.target.tagName!==undefined){var tag=e.target.tagName.toLowerCase();if(inputElements.indexOf(tag)!==-1){this.requiresNativeTap=true}}else if(e.target&&e.target.tagName!==undefined&&e.target.tagName.toLowerCase()==="input"&&e.target.type==="range"){this.requiresNativeTap=true}if($.os.chrome||$.os.fennec)return;if(!this.isPanning_&&!this.requiresNativeTap){if((this.isScrolling&&!$.feat.nativeTouchScroll)||(!this.isScrolling))e.preventDefault()}else if(this.isScrollingVertical_){this.demandVerticalScroll()}},demandVerticalScroll:function(){var atTop=this.scrollingEl_.scrollTop<=0;if(atTop){this.scrollingEl_.scrollTop=1}else{var scrollHeight=this.scrollingEl_.scrollTop+this.scrollingEl_.clientHeight;var atBottom=scrollHeight>=this.scrollingEl_.scrollHeight;if(atBottom){this.scrollingEl_.scrollTop=this.scrollingEl_.scrollHeight-this.scrollingEl_.clientHeight-1}}},ignoreScrolling:function(el){if(el.scrollWidth===undefined||el.clientWidth===undefined)return true;if(el.scrollHeight===undefined||el.clientHeight===undefined)return true;return false},allowsVerticalScroll:function(el,styles){var overflowY=styles.overflowY;if(overflowY==="scroll")return true;if(overflowY==="auto"&&el.scrollHeight>el.clientHeight)return true;return false},allowsHorizontalScroll:function(el,styles){var overflowX=styles.overflowX;if(overflowX==="scroll")return true;if(overflowX==="auto"&&el.scrollWidth>el.clientWidth)return true;return false},checkDOMTree:function(el,parentTarget){if(requirePanning&&this.panElementId===el.id){this.isPanning_=true;return}if($.feat.nativeTouchScroll){if(this.ignoreScrolling(el)){return}var styles=window.getComputedStyle(el);if(this.allowsVerticalScroll(el,styles)){this.isScrollingVertical_=true;this.scrollingEl_=el;this.isScrolling=true;return}else if(this.allowsHorizontalScroll(el,styles)){this.isScrollingVertical_=false;this.scrollingEl_=null;this.isScrolling=true}}var isTarget=(el===parentTarget);if(!isTarget&&el.parentNode)this.checkDOMTree(el.parentNode,parentTarget)},scrollEnded:function(e){if(this.scrollTimeoutEl_===null){return}if(e)this.scrollTimeoutEl_.removeEventListener("scroll",this.scrollEndedProxy_,false);this.fireEvent("UIEvents","scrollend",this.scrollTimeoutEl_,false,false);this.scrollTimeoutEl_=null},onTouchMove:function(e){var wasMoving=this.moved;this.moved=true;if(verySensitiveTouch){this.cY=e.touches[0].pageY-this.dY;this.cX=e.touches[0].pageX-this.dX}if(this.isPanning_){return}if(this.isScrolling){if(!wasMoving){this.fireEvent("UIEvents","scrollstart",this.scrollingEl_,false,false)}this.speedY=(this.lastY-e.touches[0].pageY)/(e.timeStamp-this.lastTimestamp);this.lastY=e.touches[0].pageY;this.lastX=e.touches[0].pageX;this.lastTimestamp=e.timeStamp}if((!$.os.blackberry10)){if(!this.isScrolling||!$.feat.nativeTouchScroll)e.preventDefault();return}},onTouchEnd:function(e){var itMoved=this.moved;if(verySensitiveTouch){itMoved=itMoved&&!(Math.abs(this.cX)<10&&Math.abs(this.cY)<10)}if(!$.os.ios||!this.requiresNativeTap)this.allowDocumentScroll_=false;if(this.isPanning_&&itMoved){this.wasPanning_=true}else if(!itMoved&&!this.requiresNativeTap){this.scrollerIsScrolling=false;if(!this.trackingClick){return}e.preventDefault();if(!this.blockClicks&&!this.blockPossibleClick_){var theTarget=e.target;var changedTouches=e.changedTouches?e.changedTouches[0]:e.touches[0];if(theTarget.nodeType===3)theTarget=theTarget.parentNode;this.fireEvent("Event","click",theTarget,true,e.mouseToTouch,changedTouches[0]);this.lastTouchStartX=this.dX;this.lastTouchStartY=this.dY}}else if(itMoved){if(this.isScrolling){this.scrollTimeoutEl_=this.scrollingEl_;if(Math.abs(this.speedY)<0.01){this.scrollEnded(false)}else{this.scrollTimeout_=setTimeout(this.scrollTimeoutExpireProxy_,30)}}if(this.requiresNativeTap){if(!this.isFocused_)$.trigger(this,"cancel-enter-edit",[e.target])}}if($.os.blackberry10){this.lastTouchStartX=this.dX;this.lastTouchStartY=this.dY}this.clearTouchVars()},clearTouchVars:function(){this.speedY=this.lastY=this.cY=this.cX=this.dX=this.dY=0;this.moved=false;this.isPanning_=false;this.isScrolling=false;this.isScrollingVertical_=false;this.requiresNativeTap=false;this.blockPossibleClick_=false;this.trackingClick=false},fireEvent:function(eventType,eventName,target,bubbles,mouseToTouch,data){var theEvent=document.createEvent(eventType);theEvent.initEvent(eventName,bubbles,true);if(data){$.each(data,function(key,val){theEvent.key=val})}if(mouseToTouch)theEvent.mouseToTouch=true;target.dispatchEvent(theEvent)}}})(af);